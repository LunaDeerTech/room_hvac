# room_hvac 功能规格说明（Functional Specification）

## 1. 集成概述（Overview）

`room_hvac` 是一个 Home Assistant 自定义 integration，用于在“房间”这一逻辑层级上统一管理制冷、除湿、送风与制热能力。
该集成对外仅暴露一个标准 `climate` 实体，作为房间温控的**唯一推荐控制入口**；对内则根据当前运行模式，将控制指令路由到不同的下游 `climate` 设备（空调或地暖）。

`room_hvac` 的核心职责是模式仲裁、参数映射与状态一致性维护，而不是对底层设备能力进行增强或替代。

---

## 2. 设计目标（Design Goals）

该集成的设计目标包括：

* 提供一个语义清晰、行为可预测的房间级 HVAC 控制实体
* 在不同运行模式下自动选择正确的执行设备
* 支持用户自定义的 preset 体系，并与底层设备能力解耦
* 在可选的“强制模式”下，保证控制一致性，防止多入口误操作
* 保持与 Home Assistant 原生 `climate` 生态高度兼容

---

## 3. 支持的实体与前置条件

在配置 `room_hvac` 时，用户必须选择两个现有的 `climate` 实体：

* **空调实体（Air Conditioner Climate）**
  用于执行 `cool`、`dry`、`fan_only` 模式，需支持 HVAC 模式切换与风速控制能力。

* **地暖实体（Floor Heating Climate）**
  用于执行 `heat` 模式，需支持目标温度设置能力。

两个实体在语义上被视为“执行器”，不再是推荐的直接操作对象。

---

## 4. room_hvac 实体能力定义

`room_hvac` 对外表现为一个标准 `climate` 实体，支持以下能力：

* HVAC 模式（`hvac_mode`）
* 目标温度（`target_temperature`）
* 当前温度（`current_temperature`）
* 预设模式（`preset_mode`）
* 关闭状态（`off`）

---

## 5. HVAC 模式与路由规则

`room_hvac` 支持以下 HVAC 模式：

* `off`
* `cool`（制冷）
* `dry`（除湿）
* `fan_only`（仅送风）
* `heat`（制热）

### 5.1 模式与执行器映射关系

* `cool` / `dry` / `fan_only`

  * 执行器：空调
  * 行为：空调启用对应模式，地暖强制关闭

* `heat`

  * 执行器：地暖
  * 行为：地暖启用制热模式，空调强制关闭

* `off`

  * 行为：空调与地暖均关闭

在任何时刻，只允许**一个下游设备处于激活状态**。

---

## 6. 温度控制逻辑

### 6.1 目标温度（target_temperature）

`room_hvac` 允许用户在所有支持温控的模式下设置目标温度。

* 在 `cool` / `dry` / `heat` 模式下：
  目标温度直接下发给当前生效的下游 `climate` 实体。

* 在 `fan_only` 模式下：
  目标温度不参与控制逻辑，设置请求被忽略但不报错。

模式切换时不恢复历史温度值，仅以当前 UI 中的设定为准。

### 6.2 当前温度（current_temperature）

`current_temperature` 始终取自**当前被控制的下游设备**：

* 空调类模式：来自空调实体
* 制热模式：来自地暖实体

模式切换导致温度来源发生跳变是**预期且可接受的行为**。

---

## 7. Preset 体系设计

### 7.1 Preset Slot 概念

`room_hvac` 提供两套独立的 preset slot 配置体系：

* 空调 preset（用于 `cool` / `dry` / `fan_only`）
* 地暖 preset（用于 `heat`）

每一套均提供 **4 个可配置 slot**，仅作为默认模板：

* Slot 数量固定为 4
* Slot 名称与图标完全可由用户修改
* Slot 语义不写死，仅作为映射容器

### 7.2 空调 Preset 行为

空调 preset 用于风量映射：

* 每个 slot 可映射到空调 `fan_mode` 的一个具体值
* 未配置风速的 slot 不会出现在 UI 的 preset 列表中
* Preset 不修改目标温度，仅影响风速

该 preset 集合在 `cool` / `dry` / `fan_only` 模式下共用。

### 7.3 地暖 Preset 行为

地暖 preset 用于预设温度映射：

* 每个 slot 映射一个固定目标温度
* 未配置温度的 slot 不显示
* Preset 触发时直接设置地暖目标温度

### 7.4 Preset 的显示规则

`preset_modes` 是一个**动态属性**：

* 当前模式为空调类 → 显示空调 preset 列表
* 当前模式为制热 → 显示地暖 preset 列表
* `off` 模式 → 不显示 preset

---

## 8. 强制模式（Force Control Mode）

### 8.1 功能定义

在配置阶段，用户可以启用“强制模式”选项。

启用后，`room_hvac` 成为**唯一权威控制源**，下游设备的任何不一致状态变更都会被视为外部误操作。

### 8.2 行为规则

在强制模式下：

* 如果下游设备的 HVAC 模式与 `room_hvac` 当前模式不一致 → 立即回写纠正
* 如果非当前执行器设备被外部开启 → 立即关闭
* 如果下游设备参数（风速 / 温度）被外部修改，与当前 preset 或目标温度不一致 → 回写纠正

### 8.3 失败处理策略

在强制模式下，如果纠正操作失败（实体不可用、服务调用异常）：

* `room_hvac` 直接抛出错误
* 不做自动降级、不切换为非强制模式
* 不进行重试策略

---

## 9. 状态监听与一致性控制

`room_hvac` 必须监听空调与地暖实体的状态变化事件。

监听逻辑需要具备以下能力：

* 判断状态变更是否由 `room_hvac` 自身发起
* 避免回写导致的事件循环
* 在强制模式下执行纠错，在非强制模式下允许状态反向同步

---

## 10. 属性与可观测性（Attributes）

建议 `room_hvac` 至少暴露以下附加属性，用于调试与理解系统行为：

* 当前生效的下游实体 ID
* 是否启用强制模式
* 当前运行类别（空调类 / 地暖类）
* 最近一次检测到的外部干预类型（如有）

---

## 11. 非目标与明确不支持项

以下行为明确不在本集成的设计范围内：

* 自动记忆并恢复“上一次模式的 preset 或温度”
* 多设备并行运行（空调与地暖同时启用）
* 复杂的失败自愈或降级策略
* 脱离 Home Assistant `climate` 语义的自定义控制模型
