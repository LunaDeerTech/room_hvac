# Config Flow 逐步交互与校验逻辑说明

---

## 1. Config Flow 总体原则

`room_hvac` 的 Config Flow 目标不是“快速创建实体”，而是**确保配置结果在语义与能力层面一定可用**。因此流程采用**分步向导式（wizard）交互**，每一步只解决一个明确问题，并在该步骤完成必要校验。

整体流程遵循以下原则：

* 所有实体选择都基于 Home Assistant 现有实体注册表
* 能力校验尽量前置，避免用户完成大量配置后才发现不可用
* preset 配置允许“部分完成”，未配置的 slot 自动被忽略
* 不引入隐式默认行为，所有关键策略必须显式选择或接受默认值

---

## 2. Flow Step 结构总览

完整 Config Flow 建议拆分为以下步骤：

1. 选择下游 climate 实体
2. 基础行为选项配置
3. 空调 preset 配置
4. 地暖 preset 配置
5. 配置确认与创建

每一步都是一个独立的 flow step，避免在单一表单中堆叠过多选项。

---

## 3. Step 1：选择下游 Climate 实体

### 3.1 交互内容

向用户展示两个必选字段：

* 空调 climate 实体（entity_id 选择器，仅限 `domain=climate`）
* 地暖 climate 实体（entity_id 选择器，仅限 `domain=climate`）

### 3.2 校验逻辑

在用户提交后，必须进行以下校验：

* 两个实体不能是同一个 entity_id
* 两个实体当前状态不能为 `unknown` 或 `unavailable`（至少在配置时可用）
* 校验实体域是否为 `climate`（防止手工输入或异常情况）

### 3.3 能力探测（建议）

在此步骤完成后，立即读取两个实体的 state attributes，用于后续流程判断：

* 空调实体：

  * 是否支持 `fan_mode`
  * 支持的 `fan_modes` 列表
  * 支持的 `hvac_modes`

* 地暖实体：

  * 是否支持 `target_temperature`
  * 是否支持 `heat` 模式

若发现明显不满足最低要求的实体，应在此步骤直接报错并阻止继续。

---

## 4. Step 2：基础行为选项配置

### 4.1 交互内容

此步骤用于配置**影响整体行为策略的选项**，建议包括：

* 是否启用强制模式（Force Control Mode）

  * 布尔开关
  * 默认值建议为 `false`

可选（非必须，但推荐）：

* room_hvac 显示名称、图标

  * 默认使用自动生成名称
  * 允许用户在此步骤自定义

### 4.2 校验逻辑

该步骤无复杂校验，仅需保证字段类型正确。

---

## 5. Step 3：空调 Preset 配置

### 5.1 交互内容

此步骤用于配置**空调类模式（cool / dry / fan_only）使用的 preset**。

对于 4 个 preset slot，分别提供以下配置项：

* Slot 名称（文本，可空）
* Slot 图标（icon selector，可空）
* 对应空调风速（下拉选择，来自空调实体的 `fan_modes`）

默认占位名称、图标
| 名称 | 图标 |
|------|------|
| 自动 | mdi:fan-auto |
| 静音 | mdi:weather-night |
| 中速 | mdi:speedometer-medium |
| 全速 | mdi:speedometer |

UI 层面建议将每个 slot 显示为一个可折叠区域，避免信息密度过高。

### 5.2 校验逻辑

* 若某个 slot 未选择风速，则该 slot 视为“未配置”，无需报错
* 若选择了风速，但名称为空，可使用系统默认名称
* 所选风速必须存在于空调实体的 `fan_modes` 中

### 5.3 配置结果处理

* 至少允许 **0 个** 空调 preset（全部不配置也合法）
* 最终仅保存“已配置风速”的 slot
* slot 顺序不影响功能，仅影响 UI 显示顺序

---

## 6. Step 4：地暖 Preset 配置

### 6.1 交互内容

此步骤用于配置**制热模式下的 preset**。

对于 4 个 preset slot，分别提供：

* Slot 名称（文本，可空）
* Slot 图标（icon selector，可空）
* 预设目标温度（数值输入，单位 °C）

默认占位名称、图标
| 名称 | 图标 |
|------|------|
| 外出 | mdi:account-arrow-left-outline |
| 在家 | mdi:home |
| 活动 | mdi:dumbbell |
| 睡眠 | mdi:bed |

### 6.2 校验逻辑

* 若某个 slot 未填写温度，则视为未配置
* 温度需落在合理区间内（例如 5–35°C，具体可配置）
* 若地暖实体存在 min/max temperature 属性，应以其为准

### 6.3 配置结果处理

* 至少允许 **0 个** 地暖 preset
* 最终仅保存“已配置温度”的 slot
* preset 温度仅在 preset 被激活时生效

---

## 7. Step 5：配置确认与创建

### 7.1 交互内容

向用户展示一个配置摘要，用于最终确认：

* 选定的空调与地暖实体
* 是否启用强制模式
* 已配置的空调 preset 数量
* 已配置的地暖 preset 数量

该步骤不再允许编辑，仅用于确认。

### 7.2 创建逻辑

* 为该配置创建一个 `config_entry`
* 以该 entry 初始化 `room_hvac` 实体
* 将所有 preset 与行为选项作为 entry data 保存

---

## 8. 重新配置（Options Flow）建议

虽然不在首次 Config Flow 范围内，但强烈建议实现 Options Flow，用于：

* 修改强制模式开关
* 调整 preset 配置
* 更换下游实体（需重新校验能力）

Options Flow 的结构可以与 Config Flow 高度复用，但需注意对“运行中实体”的状态影响。

---

## 9. 错误提示与用户反馈原则

所有校验失败应遵循以下原则：

* 明确指出是哪个字段、哪类问题
* 避免使用“不支持”“失败”等模糊描述
* 优先给出可操作的修正建议（如“请选择支持风速的空调实体”）

---

## 10. 小结

在当前设计下，`room_hvac` 的 Config Flow 具备以下特征：

* 步骤清晰、职责单一
* 校验前置，失败可预期
* preset 配置灵活，不强迫用户完成
* 与核心功能规格完全一致，无隐式行为
